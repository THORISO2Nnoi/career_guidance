<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 10 - Stream Selection</title>
    <style>
        /* CSS Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #2E8B57;
            --primary-dark: #256f47;
            --secondary: #FF6B35;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --accent: #3498db;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #2E8B57 0%, #3498db 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        h1 {
            color: var(--dark);
            margin-bottom: 0.5rem;
            font-size: 2.5rem;
        }
        
        header p {
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .back-button {
            margin-bottom: 2rem;
        }
        
        .back-button a {
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .back-button a:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .steps {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .step {
            padding: 2rem;
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step h2 {
            color: var(--dark);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 3rem 2rem;
            text-align: center;
            background: rgba(46, 139, 87, 0.05);
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        
        .upload-area.highlight {
            border-color: var(--secondary);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .upload-area p {
            margin-bottom: 1rem;
            color: var(--gray);
        }
        
        .file-info {
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .secondary-btn {
            background: var(--gray);
        }
        
        .secondary-btn:hover {
            background: #5a6268;
        }
        
        .analyze-btn {
            width: 100%;
            margin-top: 1rem;
        }
        
        .upload-success {
            text-align: center;
        }
        
        .success-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .file-name {
            font-weight: 600;
            margin: 1rem 0;
        }
        
        .change-file-btn {
            background: var(--gray);
        }
        
        .upload-status {
            margin-top: 1rem;
            padding: 0.5rem;
            border-radius: 5px;
            text-align: center;
        }
        
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading-container {
            text-align: center;
            padding: 3rem;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-container {
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Results Styling */
        .results-header {
            background: var(--light);
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .performance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .summary-card h4 {
            margin-bottom: 1rem;
            color: var(--gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .aps-score-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .aps-score-display.outstanding { color: #28a745; }
        .aps-score-display.excellent { color: #17a2b8; }
        .aps-score-display.good { color: #ffc107; }
        .aps-score-display.adequate { color: #fd7e14; }
        .aps-score-display.needs-improvement { color: #dc3545; }
        
        .aps-value {
            display: block;
            line-height: 1;
        }
        
        .aps-label {
            font-size: 0.9rem;
            font-weight: normal;
            color: var(--gray);
        }
        
        .performance-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .performance-score .emoji {
            font-size: 2rem;
        }
        
        .performance-score .score {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .performance-score .level {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .streams-count .number {
            display: block;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .streams-count .label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .key-message {
            background: #e7f3ff;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .key-message h4 {
            margin-bottom: 0.5rem;
            color: var(--accent);
        }
        
        .subjects-breakdown {
            margin-bottom: 2rem;
        }
        
        .subjects-breakdown h4 {
            margin-bottom: 1rem;
        }
        
        .subjects-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .subjects-table th,
        .subjects-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .subjects-table th {
            background: var(--light);
            font-weight: 600;
        }
        
        .subjects-table tfoot {
            background: var(--light);
            font-weight: 600;
        }
        
        .level-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .level-badge.distinction { background: #d4edda; color: #155724; }
        .level-badge.merit { background: #cce7ff; color: #004085; }
        .level-badge.achieved { background: #fff3cd; color: #856404; }
        .level-badge.satisfactory { background: #ffeaa7; color: #8d7100; }
        .level-badge.elementary { background: #f8d7da; color: #721c24; }
        
        .points-cell {
            font-weight: 600;
            text-align: center;
        }
        
        .total-points {
            font-size: 1.2rem;
            color: var(--primary);
            text-align: center;
        }
        
        .core-subjects-analysis {
            margin-bottom: 2rem;
        }
        
        .core-subjects-analysis h4 {
            margin-bottom: 1rem;
        }
        
        .core-subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .core-subject-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }
        
        .core-subject-card.excellent { border-left-color: #28a745; }
        .core-subject-card.good { border-left-color: #17a2b8; }
        .core-subject-card.moderate { border-left-color: #ffc107; }
        .core-subject-card.weak { border-left-color: #fd7e14; }
        
        .subject-name {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .subject-mark {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .subject-level {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }
        
        .subject-suitability {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            background: var(--light);
        }
        
        .stream-recommendations {
            margin-bottom: 2rem;
        }
        
        .stream-recommendations h4 {
            margin-bottom: 1rem;
        }
        
        .streams-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .stream-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--primary);
        }
        
        .stream-card.high-priority { border-left-color: #28a745; }
        .stream-card.medium-priority { border-left-color: #17a2b8; }
        .stream-card.low-priority { border-left-color: #ffc107; }
        
        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stream-header h5 {
            font-size: 1.3rem;
            color: var(--dark);
        }
        
        .stream-rating {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }
        
        .suitability {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .suitability.high { background: #d4edda; color: #155724; }
        .suitability.medium { background: #fff3cd; color: #856404; }
        .suitability.low { background: #f8d7da; color: #721c24; }
        
        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--light);
        }
        
        .priority-badge.high-priority { background: #d4edda; color: #155724; }
        .priority-badge.medium-priority { background: #fff3cd; color: #856404; }
        .priority-badge.low-priority { background: #f8d7da; color: #721c24; }
        
        .stream-aps-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--light);
            border-radius: 5px;
        }
        
        .your-aps.qualified { color: #28a745; font-weight: 600; }
        .your-aps.not-qualified { color: #dc3545; font-weight: 600; }
        
        .stream-description {
            margin-bottom: 1.5rem;
            color: var(--gray);
        }
        
        .stream-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .detail-section h6 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .detail-section ul {
            list-style-type: none;
        }
        
        .detail-section li {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .detail-section li:last-child {
            border-bottom: none;
        }
        
        .suitability-analysis {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .suitability-analysis h6 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .suitability-analysis ul {
            list-style-type: none;
        }
        
        .suitability-analysis li {
            padding: 0.25rem 0;
            position: relative;
            padding-left: 1.5rem;
        }
        
        .suitability-analysis li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--primary);
            font-weight: bold;
        }
        
        .stream-requirements {
            background: #e7f3ff;
            padding: 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .next-steps {
            background: #fff3cd;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .next-steps h4 {
            margin-bottom: 1rem;
            color: #856404;
        }
        
        .next-steps ul {
            list-style-type: none;
        }
        
        .next-steps li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(133, 100, 4, 0.1);
            position: relative;
            padding-left: 1.5rem;
        }
        
        .next-steps li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #856404;
            font-weight: bold;
        }
        
        .next-steps li:last-child {
            border-bottom: none;
        }
        
        .results-footer {
            text-align: center;
            padding: 1rem;
            background: var(--light);
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }
        
        footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            text-align: center;
            color: var(--gray);
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .performance-summary,
            .core-subjects-grid,
            .stream-details {
                grid-template-columns: 1fr;
            }
            
            .stream-header {
                flex-direction: column;
                gap: 1rem;
            }
            
            .stream-rating {
                align-items: flex-start;
            }
            
            .stream-aps-info {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Grade 10 - Stream Selection</h1>
        <p>Upload your Grade 9 results to discover your academic streams and where they're offered in Mpumalanga</p>
    </header>
    
    <main>
        <div class="container">
            <div class="back-button">
                <a href="index.html">&larr; Back to Home</a>
            </div>
            
            <div class="steps">
                <div class="step active" id="step1">
                    <h2>Step 1: Upload Your Grade 9 Results</h2>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📄</div>
                        <p>Drag & drop your results file here or</p>
                        <input type="file" id="resultsFile" accept=".pdf,.jpg,.jpeg,.png">
                        <label for="resultsFile" class="btn">Choose File</label>
                        <p class="file-info">Supported formats: PDF, JPG, PNG (Max: 5MB)</p>
                    </div>
                    <div class="upload-status" id="uploadStatus"></div>
                    <button class="btn analyze-btn" id="analyzeBtn" disabled>Analyze Results & Calculate APS</button>
                </div>
                
                <div class="step" id="step2">
                    <h2>Step 2: Your Results Analysis & Stream Recommendations</h2>
                    <div id="loadingResults" class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>Processing your results and calculating APS...</p>
                    </div>
                    <div id="streamResults" class="results-container">
                        <!-- Results will be populated by JavaScript -->
                    </div>
                    <div class="action-buttons">
                        <button class="btn secondary-btn" id="restartBtn">Analyze Another Result</button>
                        <button class="btn hidden" id="printBtn">Print Results</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2023 Student Career Guidance Portal. All rights reserved.</p>
    </footer>
    
    <script>
        // Global variables
        let uploadedFile = null;
        const API_BASE = 'http://localhost:5000/api';

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            initGrade10Page();
        });

        function initGrade10Page() {
            const resultsFile = document.getElementById('resultsFile');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const restartBtn = document.getElementById('restartBtn');
            const printBtn = document.getElementById('printBtn');
            
            // File upload handling
            if (resultsFile) {
                resultsFile.addEventListener('change', function(e) {
                    handleFileUpload(e, analyzeBtn);
                });
            }
            
            // Analyze button
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', async function() {
                    await submitGrade10Data();
                });
            }
            
            // Restart button
            if (restartBtn) {
                restartBtn.addEventListener('click', function() {
                    resetForm();
                });
            }

            // Print button
            if (printBtn) {
                printBtn.addEventListener('click', function() {
                    window.print();
                });
            }

            // Drag and drop functionality
            setupDragAndDrop();
        }

        function handleFileUpload(e, buttonElement) {
            if (e.target.files.length > 0) {
                uploadedFile = e.target.files[0];
                
                // Validate file size (5MB limit)
                if (uploadedFile.size > 5 * 1024 * 1024) {
                    showUploadStatus('File size exceeds 5MB limit. Please choose a smaller file.', 'error');
                    buttonElement.disabled = true;
                    return;
                }
                
                // Validate file type
                const fileTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
                if (!fileTypes.includes(uploadedFile.type)) {
                    showUploadStatus('Invalid file type. Please upload PDF, JPG, or PNG files only.', 'error');
                    buttonElement.disabled = true;
                    return;
                }
                
                buttonElement.disabled = false;
                showUploadStatus(`File ready: ${uploadedFile.name}`, 'success');
                
                // Update upload area text
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.innerHTML = `
                    <div class="upload-success">
                        <div class="success-icon">✅</div>
                        <p>File uploaded successfully!</p>
                        <p class="file-name">${uploadedFile.name}</p>
                        <button class="btn change-file-btn" id="changeFileBtn">Change File</button>
                    </div>
                `;
                
                document.getElementById('changeFileBtn').addEventListener('click', function() {
                    resultsFile.value = '';
                    uploadedFile = null;
                    buttonElement.disabled = true;
                    initUploadArea();
                    showUploadStatus('', 'clear');
                });
            }
        }

        function initUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="upload-icon">📄</div>
                <p>Drag & drop your results file here or</p>
                <input type="file" id="resultsFile" accept=".pdf,.jpg,.jpeg,.png">
                <label for="resultsFile" class="btn">Choose File</label>
                <p class="file-info">Supported formats: PDF, JPG, PNG (Max: 5MB)</p>
            `;
            
            // Re-attach event listener
            const resultsFile = document.getElementById('resultsFile');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (resultsFile && analyzeBtn) {
                resultsFile.addEventListener('change', function(e) {
                    handleFileUpload(e, analyzeBtn);
                });
            }

            // Setup drag and drop again
            setupDragAndDrop();
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            if (!uploadArea) return;

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                uploadArea.classList.add('highlight');
            }

            function unhighlight() {
                uploadArea.classList.remove('highlight');
            }

            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                const resultsFile = document.getElementById('resultsFile');
                const analyzeBtn = document.getElementById('analyzeBtn');
                
                if (files.length > 0) {
                    resultsFile.files = files;
                    handleFileUpload({ target: { files: files } }, analyzeBtn);
                }
            }
        }

        function showUploadStatus(message, type) {
            const statusElement = document.getElementById('uploadStatus');
            if (!statusElement) return;

            statusElement.textContent = message;
            statusElement.className = 'upload-status';
            
            if (type === 'success') {
                statusElement.classList.add('success');
            } else if (type === 'error') {
                statusElement.classList.add('error');
            } else if (type === 'clear') {
                statusElement.textContent = '';
            }
        }

        async function submitGrade10Data() {
            try {
                if (!uploadedFile) {
                    alert('Please upload your results file first.');
                    return;
                }

                // Show loading state
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loadingResults = document.getElementById('loadingResults');
                const streamResults = document.getElementById('streamResults');
                
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Processing...';
                loadingResults.style.display = 'block';
                streamResults.style.display = 'none';

                // Create form data for file upload
                const formData = new FormData();
                formData.append('document', uploadedFile);

                // Use the OCR API endpoint
                const response = await fetch(`${API_BASE}/ocr/process`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Process OCR results and generate stream recommendations
                    const streamData = processOCRResults(data.data.text);
                    
                    // Hide step 1, show step 2
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    
                    // Hide loading, show results
                    loadingResults.style.display = 'none';
                    streamResults.style.display = 'block';
                    displayGrade10Results(streamData);
                    
                    // Show print button
                    document.getElementById('printBtn').classList.remove('hidden');
                } else {
                    throw new Error(data.error || 'Failed to process results');
                }
                
            } catch (error) {
                console.error('Error submitting grade 10 data:', error);
                
                // Hide loading
                document.getElementById('loadingResults').style.display = 'none';
                
                // Show error message
                const streamResults = document.getElementById('streamResults');
                streamResults.style.display = 'block';
                streamResults.innerHTML = `
                    <div class="error-message">
                        <h3>❌ Processing Error</h3>
                        <p>${error.message}</p>
                        <p>Please try uploading your file again or use manual entry.</p>
                        <button class="btn" onclick="fallbackToManualEntryGrade10()">Enter Results Manually</button>
                    </div>
                `;
                
                // Show step 2 with error
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
            } finally {
                // Reset button
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Analyze Results & Calculate APS';
                }
            }
        }

        // Process OCR text to extract subject marks
        function processOCRResults(ocrText) {
            // This is a simplified example - in a real app, you'd have more sophisticated parsing
            const subjects = [];
            const lines = ocrText.split('\n');
            
            // Common Grade 9 subjects
            const commonSubjects = [
                'Mathematics', 'English', 'Natural Science', 'Social Sciences', 
                'Economic Management Sciences', 'Technology', 'Life Orientation',
                'Creative Arts', 'Afrikaans', 'IsiZulu'
            ];
            
            lines.forEach(line => {
                commonSubjects.forEach(subject => {
                    if (line.toLowerCase().includes(subject.toLowerCase())) {
                        // Extract mark (looking for numbers)
                        const markMatch = line.match(/(\d{1,3})%/);
                        if (markMatch) {
                            const mark = parseInt(markMatch[1]);
                            subjects.push({
                                name: subject,
                                mark: mark,
                                level: getLevel(mark)
                            });
                        }
                    }
                });
            });
            
            // If no subjects found, create sample data for demo
            if (subjects.length === 0) {
                return generateSampleData();
            }
            
            return generateStreamRecommendations(subjects);
        }

        // Generate sample data for demonstration
        function generateSampleData() {
            const sampleSubjects = [
                { name: 'Mathematics', mark: 85, level: 'Distinction' },
                { name: 'English', mark: 78, level: 'Merit' },
                { name: 'Natural Science', mark: 72, level: 'Achieved' },
                { name: 'Social Sciences', mark: 68, level: 'Achieved' },
                { name: 'Economic Management Sciences', mark: 75, level: 'Merit' },
                { name: 'Technology', mark: 80, level: 'Distinction' },
                { name: 'Life Orientation', mark: 82, level: 'Distinction' }
            ];
            
            return generateStreamRecommendations(sampleSubjects);
        }

        // Generate stream recommendations based on subjects
        function generateStreamRecommendations(subjects) {
            // Calculate APS score
            let totalPoints = 0;
            const apsBreakdown = [];
            
            subjects.forEach(subject => {
                const points = calculateAPSPoints(subject.mark);
                totalPoints += points;
                apsBreakdown.push({
                    subject: subject.name,
                    mark: subject.mark,
                    level: subject.level,
                    symbol: getLevelSymbol(subject.level),
                    points: points
                });
            });
            
            const apsScore = totalPoints;
            const averagePoints = (totalPoints / subjects.length).toFixed(1);
            const overallAverage = subjects.reduce((sum, subj) => sum + subj.mark, 0) / subjects.length;
            
            // Determine performance level
            let performanceLevel, performanceEmoji;
            if (overallAverage >= 80) {
                performanceLevel = 'Excellent';
                performanceEmoji = '🎯';
            } else if (overallAverage >= 70) {
                performanceLevel = 'Good';
                performanceEmoji = '👍';
            } else if (overallAverage >= 60) {
                performanceLevel = 'Satisfactory';
                performanceEmoji = '✅';
            } else if (overallAverage >= 50) {
                performanceLevel = 'Needs Improvement';
                performanceEmoji = '⚠️';
            } else {
                performanceLevel = 'Concern';
                performanceEmoji = '❌';
            }
            
            // Analyze core subjects
            const coreSubjects = {
                mathematics: subjects.find(s => s.name === 'Mathematics'),
                english: subjects.find(s => s.name === 'English'),
                science: subjects.find(s => s.name === 'Natural Science'),
                socialSciences: subjects.find(s => s.name === 'Social Sciences')
            };
            
            const coreSubjectsAnalysis = {};
            Object.entries(coreSubjects).forEach(([key, subject]) => {
                if (subject) {
                    let suitability;
                    if (subject.mark >= 80) suitability = 'Excellent';
                    else if (subject.mark >= 70) suitability = 'Good';
                    else if (subject.mark >= 60) suitability = 'Moderate';
                    else suitability = 'Weak';
                    
                    coreSubjectsAnalysis[key] = {
                        mark: subject.mark,
                        level: subject.level,
                        suitability: suitability
                    };
                }
            });
            
            // Generate stream recommendations
            const streams = getStreamRecommendations(subjects, apsScore);
            const streamAnalysis = analyzeStreamSuitability(streams, subjects, apsScore);
            const availableStreams = streams.length;
            
            // Generate key message and guidance
            const keyMessage = getKeyMessage(apsScore, overallAverage);
            const selectionGuidance = getSelectionGuidance(apsScore);
            const nextSteps = getNextSteps(apsScore);
            
            return {
                apsScore,
                summary: {
                    overallAverage: Math.round(overallAverage),
                    performanceLevel,
                    performanceEmoji,
                    availableStreams,
                    keyMessage,
                    selectionGuidance,
                    nextSteps
                },
                apsBreakdown: {
                    breakdown: apsBreakdown,
                    totalPoints: apsScore,
                    averagePoints
                },
                performanceAnalysis: {
                    coreSubjects: coreSubjectsAnalysis
                },
                streams,
                streamAnalysis
            };
        }

        // Calculate APS points based on mark
        function calculateAPSPoints(mark) {
            if (mark >= 80) return 7;
            if (mark >= 70) return 6;
            if (mark >= 60) return 5;
            if (mark >= 50) return 4;
            if (mark >= 40) return 3;
            if (mark >= 30) return 2;
            return 1;
        }

        // Get level symbol
        function getLevelSymbol(level) {
            const symbols = {
                'Distinction': 'A',
                'Merit': 'B',
                'Achieved': 'C',
                'Satisfactory': 'D',
                'Elementary': 'E',
                'Not Achieved': 'F'
            };
            return symbols[level] || '?';
        }

        // Get stream recommendations based on subjects and APS
        function getStreamRecommendations(subjects, apsScore) {
            const allStreams = [
                {
                    name: "Science, Technology, Engineering & Mathematics (STEM)",
                    apsRange: "28-42 points",
                    description: "Focuses on mathematics, physical sciences, and technology subjects. Ideal for students interested in engineering, IT, medicine, and research careers.",
                    coreSubjects: ["Mathematics", "Physical Sciences", "Life Sciences"],
                    careerPaths: ["Engineer", "Doctor", "Data Scientist", "Research Scientist", "IT Specialist", "Architect"],
                    schools: ["Hoërskool Nelspruit", "Rob Ferreira High School", "Witbank High School", "Middelburg High School"],
                    requirements: "Strong performance in Mathematics and Natural Sciences (minimum 60%)",
                    advantages: "High demand careers, good earning potential, diverse career options",
                    challenges: "Requires strong analytical skills and dedication to complex problem-solving"
                },
                {
                    name: "Commerce & Business Studies",
                    apsRange: "24-38 points",
                    description: "Emphasizes business principles, economics, and financial management. Perfect for future entrepreneurs, accountants, and business leaders.",
                    coreSubjects: ["Mathematics", "Accounting", "Economics", "Business Studies"],
                    careerPaths: ["Accountant", "Financial Analyst", "Entrepreneur", "Marketing Manager", "Economist", "Banker"],
                    schools: ["Ermelo High School", "Hoërskool Nelspruit", "Middelburg High School", "Emalahleni Christian School"],
                    requirements: "Good performance in Mathematics and Economic Management Sciences",
                    advantages: "Versatile career options, business ownership opportunities, stable career paths",
                    challenges: "Requires attention to detail and good numerical skills"
                },
                {
                    name: "Humanities & Social Sciences",
                    apsRange: "20-35 points",
                    description: "Focuses on human behavior, societies, and communication. Excellent for careers in law, education, psychology, and social services.",
                    coreSubjects: ["English", "History", "Geography", "Life Orientation"],
                    careerPaths: ["Lawyer", "Teacher", "Psychologist", "Social Worker", "Journalist", "Public Relations"],
                    schools: ["Siyabuswa Secondary School", "Carolina High School", "Ermelo High School", "Barberton High School"],
                    requirements: "Strong language skills and good performance in Social Sciences",
                    advantages: "Diverse career options, opportunities to help others, creative problem-solving",
                    challenges: "May require further studies for specialized careers"
                },
                {
                    name: "Technical & Vocational",
                    apsRange: "18-32 points",
                    description: "Provides practical skills in technical fields. Great for hands-on learners interested in trades, manufacturing, and technical careers.",
                    coreSubjects: ["Mathematics", "Engineering Graphics & Design", "Mechanical Technology"],
                    careerPaths: ["Electrician", "Mechanic", "Civil Engineer", "Technician", "Construction Manager", "Manufacturing Specialist"],
                    schools: ["Barberton High School", "Kanyamazane Secondary School", "Witbank High School"],
                    requirements: "Good practical skills and basic mathematics competency",
                    advantages: "Hands-on learning, immediate employment opportunities, entrepreneurship potential",
                    challenges: "Physically demanding work in some fields"
                }
            ];
            
            // Filter streams based on APS score
            return allStreams.filter(stream => {
                const minAPS = parseInt(stream.apsRange.split('-')[0]);
                return apsScore >= minAPS - 5; // Allow some flexibility
            });
        }

        // Analyze stream suitability
        function analyzeStreamSuitability(streams, subjects, apsScore) {
            const analysis = {};
            
            streams.forEach(stream => {
                let suitability = "Medium";
                let priority = "Medium Priority";
                const recommendations = [];
                
                // Check APS qualification
                const minAPS = parseInt(stream.apsRange.split('-')[0]);
                if (apsScore >= minAPS + 5) {
                    suitability = "High";
                    priority = "High Priority";
                    recommendations.push("Your APS score well exceeds the minimum requirement for this stream");
                } else if (apsScore >= minAPS) {
                    suitability = "Medium";
                    priority = "Medium Priority";
                    recommendations.push("Your APS score meets the minimum requirement for this stream");
                } else {
                    suitability = "Low";
                    priority = "Low Priority";
                    recommendations.push("Your APS score is below the typical requirement for this stream");
                }
                
                // Check subject alignment
                stream.coreSubjects.forEach(subjectName => {
                    const subject = subjects.find(s => s.name === subjectName);
                    if (subject) {
                        if (subject.mark >= 70) {
                            recommendations.push(`Strong performance in ${subjectName} (${subject.mark}%)`);
                        } else if (subject.mark >= 50) {
                            recommendations.push(`Adequate performance in ${subjectName} (${subject.mark}%)`);
                        } else {
                            recommendations.push(`Weak performance in ${subjectName} (${subject.mark}%) - may need improvement`);
                        }
                    } else {
                        recommendations.push(`No Grade 9 results for ${subjectName} - consider your interest in this subject`);
                    }
                });
                
                analysis[stream.name] = {
                    suitability,
                    priority,
                    recommendations
                };
            });
            
            return analysis;
        }

        // Get key message based on APS and average
        function getKeyMessage(apsScore, average) {
            if (apsScore >= 35) {
                return "Outstanding academic performance! You have excellent prospects for university studies and competitive streams.";
            } else if (apsScore >= 28) {
                return "Strong academic performance. You qualify for most degree programs and have good stream options.";
            } else if (apsScore >= 24) {
                return "Good academic performance. You have solid options for diploma programs and various streams.";
            } else if (apsScore >= 20) {
                return "Adequate academic performance. Consider technical and vocational streams that match your strengths.";
            } else {
                return "Your results indicate areas for improvement. Focus on skills development and consider streams that match your interests.";
            }
        }

        // Get selection guidance
        function getSelectionGuidance(apsScore) {
            if (apsScore >= 35) {
                return "You can consider any stream - choose based on your interests and career goals.";
            } else if (apsScore >= 28) {
                return "Focus on streams that match your strongest subjects and personal interests.";
            } else if (apsScore >= 24) {
                return "Consider streams where you have demonstrated strengths and good performance.";
            } else {
                return "Look for streams that align with your best subjects and consider vocational options.";
            }
        }

        // Get next steps
        function getNextSteps(apsScore) {
            const steps = [
                "Discuss these recommendations with your parents/guardians and teachers",
                "Research the career paths that interest you most",
                "Visit schools that offer your preferred streams if possible",
                "Consider your personal interests beyond academic performance",
                "Attend career guidance sessions at your school"
            ];
            
            if (apsScore < 24) {
                steps.push("Focus on improving your performance in key subjects during Grade 10");
                steps.push("Consider extra lessons or tutoring in subjects where you struggle");
            }
            
            if (apsScore >= 28) {
                steps.push("Research university entrance requirements for your preferred fields");
            }
            
            return steps;
        }

        function fallbackToManualEntryGrade10() {
            const manualSubjects = prompt(`Please enter your subjects and marks in this format:
Mathematics:85,English:78,Natural Science:72,Social Sciences:68,EMS:75,Technology:80
(separate subjects with commas, use colon for marks)`);

            if (manualSubjects) {
                const subjects = parseManualSubjects(manualSubjects);
                if (subjects.length > 0) {
                    submitManualGrade10Results(subjects);
                } else {
                    alert('Invalid format. Please try again.');
                }
            }
        }

        function parseManualSubjects(input) {
            const subjects = [];
            const pairs = input.split(',');
            
            pairs.forEach(pair => {
                const [name, mark] = pair.split(':').map(item => item.trim());
                const numericMark = parseInt(mark);
                
                if (name && !isNaN(numericMark) && numericMark >= 0 && numericMark <= 100) {
                    subjects.push({
                        name: name,
                        mark: numericMark,
                        level: getLevel(numericMark)
                    });
                }
            });
            
            return subjects;
        }

        async function submitManualGrade10Results(subjects) {
            try {
                const loadingResults = document.getElementById('loadingResults');
                const streamResults = document.getElementById('streamResults');
                
                loadingResults.style.display = 'block';
                streamResults.style.display = 'none';

                // Process the manual entry
                const streamData = generateStreamRecommendations(subjects);
                
                loadingResults.style.display = 'none';
                streamResults.style.display = 'block';
                displayGrade10Results(streamData);
                document.getElementById('printBtn').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error submitting manual grade 10 results:', error);
                document.getElementById('loadingResults').style.display = 'none';
                
                const streamResults = document.getElementById('streamResults');
                streamResults.style.display = 'block';
                streamResults.innerHTML = `
                    <div class="error-message">
                        <h3>❌ Submission Error</h3>
                        <p>${error.message}</p>
                        <p>Please try again or contact support.</p>
                    </div>
                `;
            }
        }

        function displayGrade10Results(data) {
            const streamResults = document.getElementById('streamResults');
            if (!streamResults) return;

            let resultsHTML = `
                <div class="results-header">
                    <h3>🎓 Grade 10 Stream Recommendations</h3>
                    <div class="performance-summary">
                        <div class="summary-card">
                            <h4>APS Score</h4>
                            <div class="aps-score-display ${getAPSScoreClass(data.apsScore)}">
                                <span class="aps-value">${data.apsScore}</span>
                                <span class="aps-label">Points</span>
                            </div>
                            <p class="aps-description">${getAPSDescription(data.apsScore)}</p>
                        </div>
                        <div class="summary-card">
                            <h4>Overall Average</h4>
                            <div class="performance-score ${data.summary.performanceLevel.toLowerCase().replace(' ', '-')}">
                                <span class="emoji">${data.summary.performanceEmoji}</span>
                                <span class="score">${data.summary.overallAverage}%</span>
                                <span class="level">${data.summary.performanceLevel}</span>
                            </div>
                        </div>
                        <div class="summary-card">
                            <h4>Available Streams</h4>
                            <div class="streams-count">
                                <span class="number">${data.summary.availableStreams}</span>
                                <span class="label">Options</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="key-message">
                    <h4>📋 Analysis Summary</h4>
                    <p>${data.summary.keyMessage}</p>
                    <p><strong>${data.summary.selectionGuidance}</strong></p>
                </div>

                <div class="subjects-breakdown">
                    <h4>📊 Subject Performance & APS Calculation</h4>
                    <div class="aps-calculation">
                        <table class="subjects-table">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Mark</th>
                                    <th>Level</th>
                                    <th>APS Points</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Display subjects and their APS points
            data.apsBreakdown.breakdown.forEach(item => {
                resultsHTML += `
                    <tr>
                        <td>${item.subject}</td>
                        <td>${item.mark}%</td>
                        <td><span class="level-badge ${item.level.toLowerCase().replace(' ', '-')}">${item.symbol} ${item.level}</span></td>
                        <td class="points-cell">${item.points}</td>
                    </tr>
                `;
            });

            resultsHTML += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total APS Score:</strong></td>
                                    <td class="total-points"><strong>${data.apsBreakdown.totalPoints}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="3"><strong>Average Points per Subject:</strong></td>
                                    <td><strong>${data.apsBreakdown.averagePoints}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <div class="core-subjects-analysis">
                    <h4>🎯 Core Subjects Performance</h4>
                    <div class="core-subjects-grid">
            `;

            // Display core subjects analysis
            Object.entries(data.performanceAnalysis.coreSubjects).forEach(([subject, info]) => {
                if (info) {
                    resultsHTML += `
                        <div class="core-subject-card ${info.suitability.toLowerCase().replace(' ', '-')}">
                            <div class="subject-name">${subject.charAt(0).toUpperCase() + subject.slice(1).replace(/([A-Z])/g, ' $1')}</div>
                            <div class="subject-mark">${info.mark}%</div>
                            <div class="subject-level">${info.level}</div>
                            <div class="subject-suitability">${info.suitability}</div>
                        </div>
                    `;
                }
            });

            resultsHTML += `
                    </div>
                </div>

                <div class="stream-recommendations">
                    <h4>🚀 Recommended Streams for You</h4>
                    <div class="streams-container">
            `;

            // Display stream recommendations with suitability analysis
            data.streams.forEach(stream => {
                const analysis = data.streamAnalysis[stream.name];
                resultsHTML += `
                    <div class="stream-card ${analysis.priority.toLowerCase().replace(' ', '-')}">
                        <div class="stream-header">
                            <h5>${stream.name}</h5>
                            <div class="stream-rating">
                                <span class="suitability ${analysis.suitability.toLowerCase().replace(' ', '-')}">
                                    ${analysis.suitability}
                                </span>
                                <span class="priority-badge ${analysis.priority.toLowerCase().replace(' ', '-')}">
                                    ${analysis.priority}
                                </span>
                            </div>
                        </div>
                        
                        <div class="stream-aps-info">
                            <span class="aps-range">APS Range: ${stream.apsRange}</span>
                            <span class="your-aps ${data.apsScore >= getAPSMin(stream.apsRange) ? 'qualified' : 'not-qualified'}">
                                Your APS: ${data.apsScore} ${data.apsScore >= getAPSMin(stream.apsRange) ? '✅ Qualified' : '❌ Below Required'}
                            </span>
                        </div>
                        
                        <p class="stream-description">${stream.description}</p>
                        
                        <div class="stream-details">
                            <div class="detail-section">
                                <h6>📚 Core Subjects</h6>
                                <ul>
                                    ${stream.coreSubjects.map(subject => `<li>${subject}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="detail-section">
                                <h6>💼 Career Paths</h6>
                                <ul>
                                    ${stream.careerPaths.map(career => `<li>${career}</li>`).join('')}
                                </ul>
                            </div>
                            
                            <div class="detail-section">
                                <h6>🏫 Available Schools in Mpumalanga</h6>
                                <ul>
                                    ${stream.schools.map(school => `<li>${school}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="suitability-analysis">
                            <h6>🎯 Why this stream matches you:</h6>
                            <ul>
                                ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>

                        <div class="stream-requirements">
                            <p><strong>Requirements:</strong> ${stream.requirements}</p>
                            <p><strong>Advantages:</strong> ${stream.advantages}</p>
                            ${stream.challenges ? `<p><strong>Challenges:</strong> ${stream.challenges}</p>` : ''}
                        </div>
                    </div>
                `;
            });

            resultsHTML += `
                    </div>
                </div>

                <div class="next-steps">
                    <h4>📝 Your Next Steps</h4>
                    <ul>
                        ${data.summary.nextSteps.map(step => `<li>${step}</li>`).join('')}
                    </ul>
                </div>

                <div class="results-footer">
                    <p><strong>Note:</strong> These recommendations are based on your academic performance. Consider your personal interests, skills, and career goals when making your final decision.</p>
                </div>
            `;

            streamResults.innerHTML = resultsHTML;
            
            // Scroll to results
            streamResults.scrollIntoView({ behavior: 'smooth' });
        }

        function getLevel(mark) {
            if (mark >= 80) return 'Distinction';
            if (mark >= 70) return 'Merit';
            if (mark >= 60) return 'Achieved';
            if (mark >= 50) return 'Satisfactory';
            if (mark >= 40) return 'Elementary';
            return 'Not Achieved';
        }

        function getAPSScoreClass(apsScore) {
            if (apsScore >= 35) return 'outstanding';
            if (apsScore >= 28) return 'excellent';
            if (apsScore >= 24) return 'good';
            if (apsScore >= 20) return 'adequate';
            return 'needs-improvement';
        }

        function getAPSDescription(apsScore) {
            if (apsScore >= 35) return 'Excellent university prospects';
            if (apsScore >= 28) return 'Good degree options';
            if (apsScore >= 24) return 'Solid diploma options';
            if (apsScore >= 20) return 'Consider technical streams';
            return 'Focus on skills development';
        }

        function getAPSMin(apsRange) {
            // Extract minimum APS from range string like "28-42 points"
            const match = apsRange.match(/(\d+)/);
            return match ? parseInt(match[1]) : 0;
        }

        function resetForm() {
            // Reset to step 1
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            
            // Clear file and reset UI
            uploadedFile = null;
            document.getElementById('resultsFile').value = '';
            initUploadArea();
            showUploadStatus('', 'clear');
            
            // Hide print button
            document.getElementById('printBtn').classList.add('hidden');
            
            // Clear results
            document.getElementById('streamResults').innerHTML = '';
        }
    </script>
</body>
</html>